
#include "../Internal.h"
#include <Lumino/IO/StringReader.h>

namespace Lumino
{

//=============================================================================
// TextReader
//=============================================================================

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
TextReader::~TextReader()
{
}

//=============================================================================
// StringReader
//=============================================================================

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
StringReader::StringReader(const String& str)
	: m_src(str)
	, m_pos(0)
{
}

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
StringReader::~StringReader()
{
}

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
int StringReader::Peek()
{
	if (m_pos >= m_src.GetLength()) {
		return -1;
	}
	return m_src[m_pos];
}

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
int StringReader::Read()
{
	if (m_pos >= m_src.GetLength()) {
		return -1;
	}
	return m_src[m_pos++];
}

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
bool StringReader::ReadLine(String* line)
{
	int i = m_pos;
	while (i < m_src.GetLength())
	{
		TCHAR ch = m_src[i];
		if (ch == '\r' || ch == '\n')
		{
			if (line != NULL) {
				*line = m_src.Mid(m_pos, i - m_pos);
			}
			m_pos = i + 1;
			if (ch == '\r' && m_pos < m_src.GetLength() && m_src[m_pos] == '\n') m_pos++;
			return true;
		}
		i++;
	}

	// i は EOF にたどり着いた。そして、読み取る文字があれば読む。
	if (i > m_pos)
	{
		if (line != NULL) {
			*line = m_src.Mid(m_pos, i - m_pos);
		}
		m_pos = i;
		return true;
	}

	// EOF にたどり着いたが、読み取る文字は無かった。
	return false;
}

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
String StringReader::ReadToEnd()
{
	String s;
	if (m_pos == 0) {
		s = m_src;
	}
	else {
		s = m_src.Mid(m_pos, m_src.GetLength() - m_pos);
	}
	m_pos = m_src.GetLength();
	return s;
}

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
//int StringReader::GetPosition() const
//{
//	return m_pos;
//}

//-----------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------
bool StringReader::IsEOF()
{
	return (m_pos >= m_src.GetLength());
}

} // namespace Lumino
